<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom | Code With Pritom</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">

    <!-- Auth Guard -->
    <script src="js/ui.js"></script>
    <script src="js/auth.js"></script>
    <script>if (!Auth.isLoggedIn()) window.location.href = 'index.html';</script>
</head>

<body class="bg-gray-900 text-white h-screen flex flex-col overflow-hidden font-['Inter'] antialiased">

    <!-- ===================== HEADER ===================== -->
    <header
        class="classroom-header flex justify-between items-center px-4 py-3 bg-gray-800 border-b border-gray-700 z-50 relative">
        <div class="flex items-center gap-3">
            <a href="dashboard.html"
                class="w-8 h-8 flex items-center justify-center bg-gray-700/60 rounded-lg hover:bg-gray-600 transition text-sm text-gray-300">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <div class="truncate max-w-[150px] sm:max-w-xs">
                <h1 id="course-title" class="font-bold text-sm tracking-wide text-white truncate">Loading...</h1>
                <p id="course-meta" class="text-xs text-gray-400 truncate hidden sm:block">â€”</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <!-- Mobile Sidebar Toggle -->
            <button onclick="toggleClassroomSidebar()"
                class="btn btn-sm btn-dark md:hidden flex items-center gap-2 border border-gray-600">
                <i class="fa-solid fa-list-ul"></i>
                <span class="hidden sm:inline">Lessons</span>
            </button>

            <!-- Cart Trigger -->
            <div class="cart-trigger" onclick="Cart.toggleCart()">
                <i class="fa-solid fa-cart-shopping text-lg"></i>
                <div id="cart-badge-count" class="cart-badge" style="display:none">0</div>
            </div>

            <!-- Course Progress Badge (Desktop) -->
            <div id="course-progress-badge"
                class="hidden md:flex items-center gap-2 bg-gray-700/50 rounded-lg px-3 py-1.5">
                <div class="w-16 h-1.5 bg-gray-600 rounded-full overflow-hidden">
                    <div id="header-progress-bar" class="h-full bg-green-500 rounded-full transition-all duration-500"
                        style="width:0%"></div>
                </div>
                <span id="header-progress-text" class="text-xs text-gray-400 font-bold">0%</span>
            </div>

            <span id="lesson-counter" class="text-xs text-gray-400 hidden lg:inline">Lesson 1 of 1</span>

            <div class="w-8 h-8 bg-gradient-to-br from-orange-500 to-red-500 rounded-lg text-white flex items-center justify-center font-bold text-sm shadow-lg"
                id="cl-user-initial">U</div>
        </div>
    </header>

    <!-- Mobile Sidebar Overlay -->
    <div id="classroom-sidebar-overlay" class="classroom-sidebar-overlay md:hidden" onclick="closeClassroomSidebar()">
    </div>

    <!-- ===================== MAIN LAYOUT ===================== -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Video + Complete Section -->
        <div class="flex-1 flex flex-col">
            <!-- Video Player Area -->
            <div class="classroom-video-area">
                <div id="video-loader" class="absolute inset-0 flex items-center justify-center z-0">
                    <div class="flex flex-col items-center gap-3">
                        <div class="spinner" style="border-color:#334155;border-top-color:#f97316"></div>
                        <span class="text-sm text-gray-500">Loading video...</span>
                    </div>
                </div>
                <div id="video-wrapper"
                    class="w-full max-w-5xl aspect-video bg-black z-10 shadow-2xl rounded-lg overflow-hidden"></div>

                <!-- Lock Screen -->
                <div id="lock-screen"
                    class="hidden absolute inset-0 bg-gray-900/95 backdrop-blur-sm z-20 flex flex-col items-center justify-center">
                    <div class="bg-gray-800 p-10 rounded-2xl shadow-2xl text-center max-w-md border border-gray-700">
                        <div
                            class="w-20 h-20 bg-red-500/10 rounded-2xl flex items-center justify-center mx-auto mb-6 text-red-500">
                            <i class="fa-solid fa-lock text-3xl"></i>
                        </div>
                        <h2 class="text-2xl font-extrabold mb-3">Access Denied</h2>
                        <p class="text-gray-400 mb-8 text-sm leading-relaxed">You haven't enrolled in this course yet.
                            Purchase it to unlock all lessons.</p>
                        <button
                            onclick="if(courseData){Cart.addItem({id:courseData.id, title:courseData.title, price:courseData.price})}"
                            class="btn btn-primary btn-lg btn-pill">
                            <i class="fa-solid fa-cart-plus text-sm"></i> Add to Cart
                        </button>
                    </div>
                </div>
            </div>

            <!-- âœ… COMPLETE BAR (Below Video) -->
            <div id="complete-bar" class="complete-bar" style="display:none">
                <div class="flex items-center gap-3">
                    <button id="btn-mark-complete" onclick="markComplete()" class="btn-complete">
                        <i class="fa-solid fa-check-circle"></i>
                        <span id="complete-btn-text">Mark as Complete</span>
                    </button>
                    <span id="complete-status" class="text-xs text-gray-500 hidden sm:inline"></span>
                </div>
                <div class="flex items-center gap-2">
                    <button id="btn-prev-lesson" onclick="prevLesson()" class="btn-next" style="display:none">
                        <i class="fa-solid fa-chevron-left text-xs"></i> Previous
                    </button>
                    <button id="btn-next-lesson" onclick="nextLesson()" class="btn-next" style="display:none">
                        Next <i class="fa-solid fa-chevron-right text-xs"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ===================== SIDEBAR ===================== -->
        <aside id="classroom-sidebar" class="classroom-sidebar dark-scroll">
            <div class="p-5 border-b border-gray-700">
                <h3 class="font-bold text-gray-300 uppercase text-xs tracking-wider mb-1">Course Content</h3>
                <p id="sidebar-course-title" class="text-sm text-gray-500 truncate">â€”</p>
                <!-- Progress in Sidebar -->
                <div class="inline-progress mt-3">
                    <div class="inline-progress-bar">
                        <div id="sidebar-progress-fill" class="inline-progress-fill" style="width:0%"></div>
                    </div>
                    <span id="sidebar-progress-text" class="text-xs text-gray-400 font-bold whitespace-nowrap">0%</span>
                </div>
            </div>

            <div id="lesson-list" class="flex-1 overflow-y-auto py-2"></div>

            <!-- Hand Notes Section -->
            <div id="handnotes-section" class="border-t border-gray-700 p-4 hidden">
                <h4 class="font-bold text-xs text-gray-400 uppercase tracking-wider mb-3">
                    <i class="fa-solid fa-file-pdf mr-1 text-red-500"></i> Hand Notes
                </h4>
                <div id="handnotes-list"></div>
            </div>


        </aside>
    </div>

    <!-- ===================== CART PANEL ===================== -->
    <div id="cart-overlay" class="cart-overlay" onclick="Cart.closeCart()"></div>
    <div id="cart-panel" class="cart-panel">
        <div class="cart-header">
            <h3 class="font-bold text-slate-800">Your Cart</h3>
            <button onclick="Cart.closeCart()" class="text-slate-400 hover:text-slate-600"><i
                    class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <div id="cart-items-list" class="cart-items">
            <!-- Items injected here -->
        </div>

        <div id="cart-empty" class="p-8 text-center text-slate-400 hidden">
            <i class="fa-solid fa-cart-shopping text-4xl mb-4 opacity-50"></i>
            <p>Your cart is empty.</p>
        </div>

        <div id="cart-content" class="cart-footer">
            <div class="cart-total-row final">
                <span>Total</span>
                <span id="cart-subtotal">$0.00</span>
            </div>
            <button onclick="Cart.openCheckout()" class="btn btn-primary w-full mt-4">
                Proceed to Checkout
            </button>
        </div>
    </div>

    <!-- ===================== CHECKOUT MODAL ===================== -->
    <div id="checkout-modal-overlay" class="modal-backdrop" onclick="Cart.closeCheckout()"></div>
    <div id="checkout-modal" class="modal-container checkout-modal">
        <div class="checkout-header">
            <h2 class="font-bold text-lg text-slate-800">Secure Checkout</h2>
            <div class="stepper checkout-steps">
                <div class="step-indicator checkout-step active">
                    <div class="step-circle">1</div>
                    <div class="step-label">Cart</div>
                </div>
                <div class="step-indicator checkout-step">
                    <div class="step-circle">2</div>
                    <div class="step-label">Info</div>
                </div>
                <div class="step-indicator checkout-step">
                    <div class="step-circle">3</div>
                    <div class="step-label">Pay</div>
                </div>
                <div class="step-indicator checkout-step">
                    <div class="step-circle">4</div>
                    <div class="step-label">Done</div>
                </div>
            </div>
            <button onclick="Cart.closeCheckout()" class="text-slate-400 hover:text-slate-600"><i
                    class="fa-solid fa-xmark"></i></button>
        </div>

        <div class="checkout-body">
            <!-- Step 1: Summary -->
            <div id="checkout-step-1" class="checkout-section active">
                <h3 class="font-bold text-slate-700 mb-4">Order Summary</h3>
                <div id="checkout-cart-list" class="bg-white p-4 rounded-lg border border-gray-100 mb-6"></div>
                <div class="flex justify-between font-bold text-lg">
                    <span>Total To Pay</span>
                    <span class="checkout-total">à§³0.00</span>
                </div>
                <div class="mt-8 flex justify-end">
                    <button onclick="Cart.setStep(2)" class="btn btn-primary">
                        Continue to Billing <i class="fa-solid fa-arrow-right ml-2 text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Billing -->
            <div id="checkout-step-2" class="checkout-section">
                <div class="checkout-grid">
                    <div class="checkout-form-card">
                        <h3 class="font-bold text-slate-700 mb-4">Billing Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="form-group col-span-2 md:col-span-1">
                                <label class="form-label">Full Name</label>
                                <input type="text" id="bill-name" class="form-input" required>
                            </div>
                            <div class="form-group col-span-2 md:col-span-1">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" id="bill-phone" class="form-input" placeholder="017..." required>
                            </div>
                            <div class="form-group col-span-2">
                                <label class="form-label">Email Address</label>
                                <input type="email" id="bill-email" class="form-input" required>
                            </div>
                            <div class="form-group col-span-2">
                                <label class="form-label">Street Address</label>
                                <input type="text" id="bill-address" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">City</label>
                                <input type="text" id="bill-city" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Postal Code</label>
                                <input type="text" id="bill-zip" class="form-input" required>
                            </div>
                            <div class="form-group col-span-2">
                                <label class="form-label">Country</label>
                                <input type="text" id="bill-country" class="form-input" value="Bangladesh" readonly>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="bg-slate-50 p-6 rounded-xl border border-dashed border-slate-300">
                            <h4 class="font-bold text-slate-600 mb-2">Total Amount</h4>
                            <div class="text-3xl font-black text-slate-900 checkout-total">à§³0.00</div>
                            <p class="text-xs text-slate-400 mt-2">Next step: Payment & Promo</p>
                        </div>
                        <div class="mt-4 flex flex-col gap-3">
                            <button onclick="Cart.setStep(3)" class="btn btn-primary w-full">Next Step</button>
                            <button onclick="Cart.setStep(1)" class="btn btn-outline w-full">Back</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Promo & Payment -->
            <div id="checkout-step-3" class="checkout-section">
                <div class="checkout-grid">
                    <div>
                        <!-- Promo Code -->
                        <div class="bg-white p-4 rounded-lg border border-gray-100 mb-6 flex gap-2">
                            <input type="text" id="promo-code-input" class="form-input"
                                placeholder="Have a promo code?">
                            <button onclick="Cart.applyPromo()" class="btn btn-dark">Apply</button>
                        </div>
                        <div id="promo-feedback" class="mb-4"></div>

                        <!-- bKash -->
                        <div class="bkash-box">
                            <div class="font-bold text-xl mb-1">bKash Payment</div>
                            <p class="text-sm opacity-90 mb-4">Send Money to Merchant</p>
                            <div
                                class="text-2xl font-black bg-white/20 rounded-lg py-2 mb-2 flex items-center justify-center">
                                01853343176
                                <button id="btn-copy-bkash" onclick="Cart.copyBkash()" class="copy-btn">Copy</button>
                            </div>
                            <p class="text-xs opacity-80">Reference: Your Name</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Enter Transaction ID (TrxID)</label>
                            <input type="text" id="bkash-txn-input"
                                class="form-input text-center text-lg tracking-widest font-mono uppercase"
                                placeholder="8X20B9..." required>
                            <p class="text-xs text-slate-500 mt-1">You must complete the bKash transfer first.</p>
                        </div>
                    </div>

                    <div>
                        <div class="bg-slate-50 p-6 rounded-xl">
                            <h4 class="font-bold text-slate-600 mb-4 border-b pb-2">Final Summary</h4>
                            <div class="flex justify-between mb-2 text-sm text-slate-500">
                                <span>Subtotal</span>
                                <span class="checkout-subtotal">à§³0.00</span>
                            </div>
                            <div id="checkout-discount-row"
                                class="flex justify-between mb-2 text-sm text-green-600 font-bold hidden">
                                <span>Discount</span>
                                <span id="checkout-discount-amount">-à§³0.00</span>
                            </div>
                            <div
                                class="flex justify-between mt-4 pt-4 border-t border-slate-200 text-xl font-black text-slate-900">
                                <span>Total</span>
                                <span class="checkout-total">à§³0.00</span>
                            </div>
                        </div>
                        <div class="mt-4 flex flex-col gap-3">
                            <button id="btn-place-order" onclick="Cart.submitOrder()"
                                class="btn btn-primary w-full shadow-lg hover:shadow-orange-500/20">
                                Place Order (Verify)
                            </button>
                            <button onclick="Cart.setStep(2)" class="btn btn-outline w-full">Back</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Success -->
            <div id="checkout-step-4" class="checkout-section text-center pt-10">
                <div
                    class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 text-green-500 animate-bounce">
                    <i class="fa-solid fa-check text-4xl"></i>
                </div>
                <h2 class="text-3xl font-black text-slate-800 mb-4">Order Placed!</h2>
                <p class="text-slate-500 max-w-md mx-auto mb-8">
                    Your order <span id="conf-order-id" class="font-mono font-bold text-slate-800">#...</span> has been
                    received.
                    <br><br>
                    We are verifying your bKash payment. You will receive an email confirmation and course access within
                    <strong>2 hours</strong>.
                </p>
                <div class="flex justify-center gap-4">
                    <button onclick="window.location.href='dashboard.html'" class="btn btn-primary btn-lg">Go to
                        Dashboard</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Cart Script -->
    <script src="js/cart.js"></script>

    <!-- ===================== CLASSROOM LOGIC ===================== -->
    <script>
        const user = Auth.getUser();
        const accessList = user?.access ? user.access.toString().split(',').map(s => s.trim()) : [];
        const urlParams = new URLSearchParams(window.location.search);
        // Support both ?course_id= (new) and ?id= (legacy fallback)
        const courseId = urlParams.get('course_id') || urlParams.get('id');

        // Dynamic course data â€” will be fetched from API
        let courseData = null; // { title, price, lessons: [...] }
        let completedLessons = new Set(); // Track completed lesson indices locally for UI state

        // DOM Elements
        const wrapper = document.getElementById('video-wrapper');
        const lockScreen = document.getElementById('lock-screen');
        const titleEl = document.getElementById('course-title');
        const metaEl = document.getElementById('course-meta');
        const sidebarTitle = document.getElementById('sidebar-course-title');
        const lessonList = document.getElementById('lesson-list');
        const lessonCounter = document.getElementById('lesson-counter');
        const videoLoader = document.getElementById('video-loader');
        const completeBar = document.getElementById('complete-bar');
        const btnComplete = document.getElementById('btn-mark-complete');
        const completeBtnText = document.getElementById('complete-btn-text');
        const completeStatus = document.getElementById('complete-status');
        const btnPrev = document.getElementById('btn-prev-lesson');
        const btnNext = document.getElementById('btn-next-lesson');

        // Set user initial & prefill checkout
        if (user) {
            document.getElementById('cl-user-initial').textContent = (user?.name || 'U').charAt(0).toUpperCase();

            // Prefill checkout if fields exist
            const nameF = document.getElementById('bill-name');
            const emailF = document.getElementById('bill-email');
            if (nameF) nameF.value = user.name || '';
            if (emailF) emailF.value = user.email || '';
        }

        let currentLessonIndex = 0;

        // ===== TASK 1: CHECK USER ACCESS VIA API =====
        async function checkUserAccess(userEmail, targetCourseId) {
            console.log('[Access] Checking access for:', userEmail);
            try {
                // Direct fetch from n8n Webhook as requested
                const response = await fetch(`https://arup-vivobook-asuslaptop-x509dj-d509dj.taila8249c.ts.net/webhook/get-all-courses?email=${encodeURIComponent(userEmail)}`);
                const data = await response.json();
                console.log('[Access] API Response:', data);

                // 1. Robustly parse access codes (Array or String)
                let remoteCodes = [];

                if (Array.isArray(data)) {
                    // Handle array of objects or strings: [{course_code: "YT_123"}, "YT_456"]
                    remoteCodes = data.map(item => {
                        if (typeof item === 'object' && item !== null) {
                            // Check multiple possible keys + n8n 'json' wrapper
                            const obj = item.json || item;
                            const code = obj.course_code || obj.course_id || obj.courseCode || obj.id || obj['Course Code'];
                            return code;
                        }
                        return item;
                    }).filter(Boolean).map(String);
                } else {
                    // Fallback: Legacy comma-separated string
                    const accessString = (data?.access || data?.Access || '').toString();
                    remoteCodes = accessString.split(',').map(s => s.trim()).filter(Boolean);
                }

                console.log('[Access] Parsed Access Codes:', remoteCodes);
                console.log('[Access] Target Course ID:', targetCourseId);

                // 3. Compare with course_id from URL
                const hasAccess = remoteCodes.includes(targetCourseId);

                // Update local accessList cache
                if (remoteCodes.length > 0) {
                    accessList.length = 0; // Clear existing
                    remoteCodes.forEach(code => accessList.push(code));
                }

                return hasAccess;
            } catch (error) {
                console.error('[Access] Failed to check user access:', error);
                // Fallback to local accessList if API fails
                return accessList.includes(targetCourseId);
            }
        }

        // ===== FETCH COURSE DATA FROM API =====
        // ===== FETCH COURSE DATA FROM API =====
        async function fetchCourseData(courseCode, userEmail) {
            console.log('[Classroom] Fetching course data for:', courseCode, 'Email:', userEmail);
            try {
                // Direct fetch from n8n Webhook as requested
                const url = `https://arup-vivobook-asuslaptop-x509dj-d509dj.taila8249c.ts.net/webhook/get-all-courses?course_id=${encodeURIComponent(courseCode)}&email=${encodeURIComponent(userEmail || '')}`;
                const response = await fetch(url);

                if (!response.ok) {
                    console.error('[Classroom] API Error:', response.status, response.statusText);
                    return null;
                }

                const text = await response.text();
                if (!text) {
                    console.warn('[Classroom] Empty response from get-course-data API');
                    return null;
                }

                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    console.error('[Classroom] Invalid JSON response:', text);
                    return null;
                }

                // Normalize: API may return an array or a single object
                const raw = Array.isArray(data) ? data[0] : data;
                if (!raw) return null;

                // Build lessons array from nested data
                let lessons = [];
                if (Array.isArray(raw.lessons)) {
                    lessons = raw.lessons.map((l, idx) => ({
                        id: l.lesson_id || l.id || `${courseCode}-${idx + 1}`,
                        title: l.title || `Lesson ${idx + 1}`,
                        video: extractYouTubeId(l.video_url || ''),
                        videoUrl: l.video_url || '',
                        duration: l.duration || 'â€”',
                        lesson_number: l.lesson_number || (idx + 1)
                    }));
                }

                return {
                    id: raw.course_code || courseCode,
                    title: raw.title || 'Untitled Course',
                    price: raw.price || '0',
                    handnote: raw.handnote_url || raw.handnote || '',
                    lessons: lessons
                };
            } catch (error) {
                console.error('[Classroom] Failed to fetch course data:', error);
                return null;
            }
        }

        // ===== EXTRACT YOUTUBE VIDEO ID FROM URL =====
        function extractYouTubeId(url) {
            if (!url) return '';
            // Already a plain ID (no slashes, no dots)
            if (/^[A-Za-z0-9_-]{11}$/.test(url)) return url;
            try {
                const parsed = new URL(url);
                // youtube.com/watch?v=ID
                if (parsed.searchParams.get('v')) return parsed.searchParams.get('v');
                // youtu.be/ID
                if (parsed.hostname === 'youtu.be') return parsed.pathname.slice(1);
                // youtube.com/embed/ID
                const embedMatch = parsed.pathname.match(/\/embed\/([A-Za-z0-9_-]+)/);
                if (embedMatch) return embedMatch[1];
                // youtube.com/v/ID
                const vMatch = parsed.pathname.match(/\/v\/([A-Za-z0-9_-]+)/);
                if (vMatch) return vMatch[1];
            } catch (e) {
                // Fallback regex for malformed URLs
                const match = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/))([A-Za-z0-9_-]+)/);
                if (match) return match[1];
            }
            return url; // Return as-is if parsing fails
        }

        // ===== FETCH COMPLETED LESSONS (GET) =====
        async function fetchUserProgress(userEmail, courseCode) {
            if (!userEmail || !courseCode) return;
            console.log('[Progress] Fetching progress for:', userEmail);

            try {
                const url = `https://arup-vivobook-asuslaptop-x509dj-d509dj.taila8249c.ts.net/webhook/get-user-progress?user_email=${encodeURIComponent(userEmail)}&course_code=${encodeURIComponent(courseCode)}`;
                const response = await fetch(url);

                if (response.ok) {
                    const data = await response.json();
                    console.log('[Progress] Fetched Data:', data); // Expecting array of lesson_numbers e.g. [1, 3]

                    if (Array.isArray(data)) {
                        completedLessons.clear();

                        // Extract lesson numbers properly from objects: [{lesson_number: 1}, {lesson_number: 3}]
                        // Or if it returns flat array: [1, 3]
                        const completedNumbers = data.map(item => (typeof item === 'object' && item.lesson_number) ? item.lesson_number : item);

                        // Map lesson_numbers to current course indices
                        completedNumbers.forEach(lessonNum => {
                            // Find index of lesson with this number
                            const idx = courseData.lessons.findIndex(l => l.lesson_number == lessonNum);
                            if (idx !== -1) {
                                completedLessons.add(idx);
                            }
                        });

                        updateProgressUI();
                        renderLessons(); // Re-render checkmarks
                    }
                }
            } catch (error) {
                console.error('[Progress] Failed to fetch progress:', error);
            }
        }

        // ===== PROGRESS TRACKING (Database-backed via POST) =====
        function getProgressPercent() {
            if (!courseData || !courseData.lessons.length) return 0;
            return Math.round((completedLessons.size / courseData.lessons.length) * 100);
        }

        function isLessonCompleted(index) {
            return completedLessons.has(index);
        }

        function updateProgressUI() {
            if (!courseData) return;
            const pct = getProgressPercent();
            const total = courseData.lessons.length;
            const done = completedLessons.size;

            // Header progress
            const hBar = document.getElementById('header-progress-bar');
            const hText = document.getElementById('header-progress-text');
            if (hBar) hBar.style.width = pct + '%';
            if (hText) hText.textContent = pct + '%';

            // Sidebar progress
            const sBar = document.getElementById('sidebar-progress-fill');
            const sText = document.getElementById('sidebar-progress-text');
            if (sBar) sBar.style.width = pct + '%';
            if (sText) sText.textContent = `${done}/${total} (${pct}%)`;

            // Complete bar status
            if (completeStatus) {
                completeStatus.textContent = `${done} of ${total} completed`;
            }

            // Update course meta
            if (metaEl) metaEl.textContent = `${total} Lessons Â· ${pct}% complete`;
        }

        // ===== TASK 3: MARK LESSON AS COMPLETE (Database POST) =====
        async function markLessonAsComplete(userEmail, courseCode, lessonNumber) {
            try {
                const response = await fetch('https://arup-vivobook-asuslaptop-x509dj-d509dj.taila8249c.ts.net/webhook/save-progress', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_email: userEmail,
                        course_code: courseCode,
                        lesson_number: lessonNumber
                    })
                });

                if (response.ok) {
                    return true;
                } else {
                    console.error('[Progress] Server returned:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('[Progress] Failed to save progress:', error);
                return false;
            }
        }

        // ===== MARK COMPLETE BUTTON HANDLER =====
        async function markComplete() {
            if (!courseData || !user) return;

            const lesson = courseData.lessons[currentLessonIndex];
            if (!lesson) return;

            const alreadyDone = completedLessons.has(currentLessonIndex);

            if (alreadyDone) {
                // Toggle off (local UI only â€” server may not support un-complete)
                completedLessons.delete(currentLessonIndex);
                updateCompleteButton(false);
                UI.showToast('Lesson unmarked.', 'info');
            } else {
                // Show loading state on button
                btnComplete.disabled = true;
                completeBtnText.textContent = 'Saving...';

                if (courseData.id !== courseId) {
                    // Safety check: ensure we are modifying the course currently loaded
                    console.error('[Progress] Course mismatch! Aborting save.');
                    UI.showToast('Error: Course ID mismatch. Refresh page.', 'error');
                    return;
                }

                // POST to database
                const success = await markLessonAsComplete(
                    user.email,
                    courseData.id,
                    lesson.lesson_number
                );

                if (success) {
                    completedLessons.add(currentLessonIndex);
                    updateCompleteButton(true);

                    // Check if all lessons done
                    if (completedLessons.size === courseData.lessons.length) {
                        UI.showToast('ðŸŽ‰ Course 100% Complete! Amazing!', 'success');
                        launchConfetti();
                    } else {
                        UI.showToast('âœ… Lesson completed!', 'success');
                    }
                } else {
                    UI.showToast('Failed to save progress. Please try again.', 'error');
                    updateCompleteButton(false);
                }

                btnComplete.disabled = false;
            }

            // Refresh UI
            renderLessons();
            updateProgressUI();
        }

        function updateCompleteButton(isDone) {
            if (isDone) {
                btnComplete.classList.add('completed');
                completeBtnText.textContent = 'âœ“ Completed';
                btnComplete.querySelector('i').className = 'fa-solid fa-check-double';
            } else {
                btnComplete.classList.remove('completed');
                completeBtnText.textContent = 'Mark as Complete';
                btnComplete.querySelector('i').className = 'fa-solid fa-check-circle';
            }
        }

        // ===== CONFETTI =====
        function launchConfetti() {
            const colors = ['#10b981', '#f97316', '#6366f1', '#ec4899', '#eab308', '#3b82f6'];
            for (let i = 0; i < 40; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = Math.random() * 100 + 'vw';
                piece.style.background = colors[Math.floor(Math.random() * colors.length)];
                piece.style.animationDelay = Math.random() * 1.5 + 's';
                piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
                piece.style.width = (6 + Math.random() * 8) + 'px';
                piece.style.height = (6 + Math.random() * 8) + 'px';
                document.body.appendChild(piece);
                setTimeout(() => piece.remove(), 4000);
            }
        }

        // ===== NAVIGATION =====
        function nextLesson() {
            if (!courseData) return;
            if (currentLessonIndex < courseData.lessons.length - 1) {
                loadLesson(currentLessonIndex + 1);
            }
        }

        function prevLesson() {
            if (!courseData) return;
            if (currentLessonIndex > 0) {
                loadLesson(currentLessonIndex - 1);
            }
        }

        // ===== RENDER LESSON LIST =====
        function renderLessons() {
            if (!courseData) return;
            lessonList.innerHTML = '';
            courseData.lessons.forEach((lesson, idx) => {
                const isActive = idx === currentLessonIndex;
                const isDone = completedLessons.has(idx);
                lessonList.innerHTML += `
                    <button onclick="loadLesson(${idx})" 
                        class="lesson-item ${isActive ? 'active' : ''}" id="lesson-btn-${idx}">
                        <div class="lesson-icon ${isActive ? 'bg-orange-600 text-white' : isDone ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-400'}">
                            ${isActive
                        ? '<i class="fa-solid fa-play text-[10px]"></i>'
                        : isDone
                            ? '<i class="fa-solid fa-check text-[10px]"></i>'
                            : `<span class="text-xs font-bold">${idx + 1}</span>`
                    }
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium truncate ${isDone && !isActive ? 'line-through opacity-60' : ''}">${lesson.title}</div>
                            <div class="text-xs text-gray-500 mt-0.5">${lesson.duration}</div>
                        </div>
                        ${isDone ? '<div class="lesson-check check-pop"><i class="fa-solid fa-check text-[8px]"></i></div>' : ''}
                    </button>
                `;
            });

            // Render Hand Notes in Sidebar
            const notesSection = document.getElementById('handnotes-section');
            const notesList = document.getElementById('handnotes-list');
            if (courseData.handnote) {
                notesSection.classList.remove('hidden');
                notesList.innerHTML = `
                    <div class="handnote-item" onclick="openHandnote('${courseData.handnote}')">
                        <i class="fa-solid fa-file-lines text-orange-500 text-xl"></i>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-300">Course Hand Note</div>
                            <div class="text-xs text-gray-500">Resource Link</div>
                        </div>
                        <i class="fa-solid fa-arrow-up-right-from-square text-gray-500 text-xs"></i>
                    </div>
                `;
            } else {
                notesSection.classList.add('hidden');
            }
        }

        // ===== LOAD A SPECIFIC LESSON =====
        // ===== LOAD A SPECIFIC LESSON =====
        function loadLesson(index) {
            if (!courseData || !courseData.lessons[index]) return;
            currentLessonIndex = index;
            const lesson = courseData.lessons[index];

            // Update video â€” use extracted YouTube ID
            const videoId = lesson.video;

            if (videoId) {
                // If player exists and is valid, load new video
                if (player && typeof player.loadVideoById === 'function') {
                    // Check if iframe is actually in the DOM (wrapper might have been cleared)
                    // The YouTube API replaces the target element with an iframe.
                    // If the iframe is missing, we must re-init.
                    if (document.querySelector('iframe')) {
                        player.loadVideoById(videoId);
                    } else {
                        initPlayer(videoId);
                    }
                } else {
                    initPlayer(videoId);
                }
            } else {
                if (player && typeof player.destroy === 'function') {
                    player.destroy();
                    player = null;
                }
                wrapper.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500"><p>Video not available</p></div>';
            }
            // Hide any loader overlay
            if (videoLoader) videoLoader.style.display = 'none';

            function initPlayer(vid) {
                // Clear wrapper and create target div
                wrapper.innerHTML = '<div id="yt-player"></div>';

                // Initialize new player
                player = new YT.Player('yt-player', {
                    height: '100%',
                    width: '100%',
                    videoId: vid,
                    playerVars: {
                        'autoplay': 1,
                        'modestbranding': 1,
                        'rel': 0,
                        'fs': 1
                    },
                    events: {
                        'onStateChange': onPlayerStateChange
                    }
                });
            }

            // Update header
            lessonCounter.textContent = `Lesson ${index + 1} of ${courseData.lessons.length}`;
            document.title = `${lesson.title} | Code With Pritom`;

            // Show/hide nav buttons
            btnPrev.style.display = index > 0 ? 'inline-flex' : 'none';
            btnNext.style.display = index < courseData.lessons.length - 1 ? 'inline-flex' : 'none';

            // Update complete button state
            updateCompleteButton(isLessonCompleted(index));

            // Re-render lesson list
            renderLessons();
            updateProgressUI();



            // Scroll active lesson into view in sidebar
            setTimeout(() => {
                const activeBtn = document.getElementById(`lesson-btn-${index}`);
                if (activeBtn) activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        // ===== HANDNOTE VIEWER =====
        function openHandnote(link) {
            if (!link) return;
            // If it starts with http, open directly
            if (link.trim().startsWith('http')) {
                window.open(link, '_blank');
            } else {
                // Legacy PDF filename support
                window.open(`/api/handnotes/${link}`, '_blank');
            }
        }

        // ===== INIT (Async â€” fetches from API) =====
        (async function initClassroom() {
            if (!courseId) {
                titleEl.textContent = 'Course Not Found';
                metaEl.textContent = 'No course ID provided in the URL.';
                lockScreen.classList.remove('hidden');
                videoLoader.style.display = 'none';
                wrapper.innerHTML = '';
                const btn = lockScreen.querySelector('.btn-primary');
                if (btn) btn.style.display = 'none';
                return;
            }

            // Show loading state
            titleEl.textContent = 'Loading...';
            metaEl.textContent = 'Fetching course data...';

            // Fetch course data from API
            courseData = await fetchCourseData(courseId, user ? user.email : '');

            if (!courseData) {
                titleEl.textContent = 'Course Not Found';
                metaEl.textContent = 'This course does not exist.';
                lockScreen.classList.remove('hidden');
                videoLoader.style.display = 'none';
                wrapper.innerHTML = '';
                const btn = lockScreen.querySelector('.btn-primary');
                if (btn) btn.style.display = 'none';
                return;
            }

            // Determine Access (Freemium Model)
            const price = courseData.price;
            const isFree = (price === 0 || price === '0' || price === 'Free');

            let isUnlocked = false;

            if (isFree) {
                console.log('[Classroom] Course is FREE. Granting access.');
                isUnlocked = true;
            } else if (user?.email) {
                // Paid Course: Check Access via API
                console.log('[Classroom] Course is PAID. Checking user access...');
                try {
                    isUnlocked = await checkUserAccess(user.email, courseId);
                } catch (e) {
                    console.error('[Classroom] Access check failed:', e);
                    isUnlocked = false;
                }
            }

            // Fallback to local list if still locked (legacy/offline support)
            if (!isUnlocked && !isFree) {
                const localAccess = new Set(accessList);
                isUnlocked = localAccess.has(courseId);
            }

            titleEl.textContent = courseData.title;
            sidebarTitle.textContent = courseData.title;
            document.title = `${courseData.title} | Code With Pritom`;

            if (isUnlocked) {
                // Access Granted: Hide lock screen, show content
                lockScreen.classList.add('hidden');
                videoLoader.style.display = 'flex'; // Restore loader for initial lesson
                wrapper.innerHTML = '<div id="video-loader" class="flex flex-col items-center justify-center h-full text-slate-500"><i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4 text-orange-500"></i><p>Loading lesson...</p></div>';

                // Task 2: Fetch Lessons Dynamically (Verified Access)
                try {
                    console.log('[Classroom] Access confirmed. Checking lessons...');

                    // Use lessons from fetchCourseData if available (primary source now)
                    let lessons = courseData.lessons;

                    // Fallback to separate fetch if needed (legacy)
                    if (!lessons || lessons.length === 0) {
                        console.log('[Classroom] Fetching lessons separately...');
                        lessons = await fetchLessons(courseId);
                    }

                    if (lessons && lessons.length > 0) {
                        console.log('[Classroom] Lessons ready:', lessons.length);
                        courseData.lessons = lessons;
                    } else {
                        console.warn('[Classroom] No lessons returned from API.');

                        // DEBUG UI: Show details to help troubleshoot
                        const debugInfo = window.debugLastFetch || {};
                        const debugText = debugInfo.text || 'No response text';
                        const debugJson = debugText.length > 500 ? debugText.slice(0, 500) + '...' : debugText;

                        wrapper.innerHTML = `
                            <div class="flex flex-col items-center justify-center h-full text-slate-500 p-8 text-center">
                                <i class="fa-solid fa-bug text-4xl mb-4 text-red-400"></i>
                                <p class="text-lg font-bold mb-2">No available lessons found.</p>
                                <p class="text-sm mb-4">Course ID: <span class="font-mono bg-slate-100 px-1">${courseId}</span></p>
                                
                                <details class="w-full max-w-md bg-slate-50 p-4 rounded text-left text-xs overflow-auto border border-slate-200 mx-auto">
                                    <summary class="cursor-pointer font-bold mb-2 text-blue-500">View Debug Info</summary>
                                    <p><strong>Status:</strong> ${debugInfo.status || 'Unknown'}</p>
                                    <div class="mt-2"><strong>Response Snippet:</strong></div>
                                    <pre class="bg-white p-2 border mt-1 whitespace-pre-wrap break-words text-[10px]">${debugJson.replace(/</g, '&lt;')}</pre>
                                </details>
                            </div>`;
                        if (videoLoader) videoLoader.style.display = 'none';
                    }
                } catch (e) {
                    console.error('[Classroom] Failed to fetch lessons:', e);
                }

                // Fetch Progress from Server
                if (user?.email) {
                    await fetchUserProgress(user.email, courseData.id);
                }

                completeBar.style.display = 'flex';
                document.getElementById('course-progress-badge').classList.remove('hidden');
                renderLessons();
                loadLesson(0);
                updateProgressUI();
            } else {
                lockScreen.classList.remove('hidden');
                wrapper.innerHTML = '';
                videoLoader.style.display = 'none';

                // Show locked placeholder if data exists, otherwise empty
                metaEl.textContent = `${courseData.lessons ? courseData.lessons.length : 0} Lessons Â· Locked`;

                if (courseData.lessons) {
                    courseData.lessons.forEach(lesson => {
                        lessonList.innerHTML += `
                            <div class="lesson-item locked">
                                <div class="lesson-icon bg-gray-700 text-gray-500"><i class="fa-solid fa-lock text-[10px]"></i></div>
                                <div class="flex-1">
                                    <div class="text-sm text-gray-500">${lesson.title}</div>
                                    <div class="text-xs text-gray-600 mt-0.5">${lesson.duration}</div>
                                </div>
                            </div>
                        `;
                    });
                }
            }
        })();

        // ===== NEW: SEPARATE FETCH LESSONS API =====
        // ===== NEW: SEPARATE FETCH LESSONS API =====
        async function fetchLessons(courseCode) {
            // Direct fetch from n8n Webhook as requested
            const url = `https://arup-vivobook-asuslaptop-x509dj-d509dj.taila8249c.ts.net/webhook/get-course-data?course_id=${encodeURIComponent(courseCode)}`;
            window.debugLastFetch = { url, status: 0, text: '' };

            try {
                const response = await fetch(url);
                const text = await response.text();

                window.debugLastFetch.status = response.status;
                window.debugLastFetch.text = text;

                if (!response.ok || !text) {
                    console.warn('[Classroom] Empty or invalid response from get-course-data:', response.status);
                    return [];
                }

                let data;
                try {
                    data = JSON.parse(text);
                    console.log('[Classroom] Raw Lessons API Response:', data); // Log raw data for debugging
                } catch (e) {
                    console.error('[Classroom] JSON parse error for lessons:', text);
                    return [];
                }

                // Robust parsing for various wrapper formats
                let rawLessons = [];
                if (Array.isArray(data)) {
                    rawLessons = data;
                } else if (typeof data === 'object' && data !== null) {
                    // Check common wrapper properties
                    rawLessons = data.lessons || data.data || data.result || data.items || [];

                    // Fallback: If it looks like a single lesson object (has title/video)
                    if (rawLessons.length === 0 && (data.title || data.video_url || data.video)) {
                        rawLessons = [data];
                    }
                }

                if (rawLessons.length === 0) {
                    console.warn('[Classroom] Response parsed successfully but no lessons array found.', data);
                }

                // Map to internal structure
                return rawLessons.map((l, idx) => {
                    // Handle N8N default wrapper { json: ... } if present
                    const item = l.json || l;

                    return {
                        id: item.lesson_id || item.id || `${courseCode}-${idx + 1}`,
                        title: item.title || `Lesson ${idx + 1}`,
                        video: extractYouTubeId(item.video_url || ''),
                        videoUrl: item.video_url || '',
                        duration: item.duration || 'â€”',
                        lesson_number: item.lesson_number || (idx + 1)
                    };
                });

            } catch (error) {
                console.error('[Classroom] Error fetching lessons:', error);
                // Capture error in debug info
                if (window.debugLastFetch) {
                    window.debugLastFetch.text = 'FETCH ERROR: ' + error.toString();
                    window.debugLastFetch.status = 'Client Error';
                }
                return [];
            }
        }

        // ===== YOUTUBE PLAYER API integration =====
        let player;

        // Inject YouTube API Script
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        window.onYouTubeIframeAPIReady = function () {
            // Player ready callback
            console.log('[YouTube] API Ready');
        };

        function onPlayerStateChange(event) {
            // Task 4: Auto-Progress when video ends (State = 0)
            if (event.data === YT.PlayerState.ENDED) {
                console.log('[YouTube] Video Ended. marking complete...');
                markComplete(); // Calls update-progress API
            }
        }



        // ===== MOBILE SIDEBAR TOGGLE =====
        function toggleClassroomSidebar() {
            const sidebar = document.getElementById('classroom-sidebar');
            const overlay = document.getElementById('classroom-sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }

        function closeClassroomSidebar() {
            const sidebar = document.getElementById('classroom-sidebar');
            const overlay = document.getElementById('classroom-sidebar-overlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
        }
    </script>
</body>

</html>
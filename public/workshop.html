<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Workshop | Code With Pritom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#ea580c', secondary: '#0f172a' },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <!-- Dependencies -->
    <script src="js/ui.js"></script>
    <script src="js/auth.js"></script>
</head>

<body class="bg-slate-950 text-slate-100 font-['Inter'] antialiased min-h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="border-b border-slate-800 bg-slate-950/80 backdrop-blur-md sticky top-0 z-50 h-16 flex items-center">
        <div class="w-full px-4 md:px-6 flex justify-between items-center">
            <a href="dashboard.html" class="flex items-center gap-2 text-slate-400 hover:text-white transition group">
                <i class="fa-solid fa-chevron-left text-xs group-hover:-translate-x-1 transition"></i>
                <span class="font-medium text-sm">Dashboard</span>
            </a>

            <div class="flex items-center gap-3" id="live-indicator">
                <span class="animate-pulse w-2 h-2 rounded-full bg-red-500"></span>
                <span class="font-bold tracking-tight text-white" id="workshop-title-nav">Live Workshop</span>
            </div>

            <div class="w-20 text-right">
                <div
                    class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-slate-800 text-xs font-bold text-slate-300 ring-2 ring-slate-800">
                    <i class="fa-solid fa-user"></i>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Interface -->
    <main class="flex-1 flex flex-col lg:flex-row h-[calc(100vh-64px)] w-full relative" id="main-layout">

        <!-- Video Player Area -->
        <div class="flex-1 bg-black relative group flex items-center justify-center bg-slate-950" id="player-container">
            <div class="w-full h-full relative" id="video-wrapper">
                <iframe id="workshop-player" class="w-full h-full absolute inset-0" src="" title="Workshop"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowfullscreen></iframe>

                <!-- Overlay (Waiting) -->
                <div id="player-overlay"
                    class="absolute inset-0 bg-slate-900 z-10 flex flex-col items-center justify-center hidden">
                    <i class="fa-brands fa-youtube text-6xl text-slate-700 mb-4"></i>
                    <p class="text-slate-500 font-medium text-lg" id="overlay-msg">Connecting...</p>
                </div>
            </div>
        </div>

        <!-- Right Sidebar (Chat) -->
        <div class="w-full lg:w-[400px] bg-slate-900 border-l border-slate-800 flex flex-col" id="workshop-sidebar">

            <div class="px-4 py-3 border-b border-slate-800 flex justify-between items-center bg-slate-900">
                <span class="font-semibold text-sm text-slate-300">Live Chat</span>
                <div class="flex gap-2">
                    <span
                        class="text-[10px] bg-red-500/10 text-red-500 px-2 py-0.5 rounded font-bold border border-red-500/20">LIVE</span>
                </div>
            </div>

            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4 scroll-smooth">
                <div class="flex gap-3">
                    <div
                        class="w-8 h-8 rounded-full bg-orange-600/20 flex items-center justify-center text-orange-500 text-xs shrink-0">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div>
                        <div class="flex items-baseline gap-2">
                            <span class="text-xs font-bold text-orange-500">System</span>
                            <span class="text-[10px] text-slate-600">Now</span>
                        </div>
                        <p class="text-sm text-slate-400 mt-0.5">Welcome! Chat is open.</p>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-slate-800 bg-slate-900">
                <form onsubmit="event.preventDefault();" class="relative">
                    <input type="text" placeholder="Type a message..."
                        class="w-full bg-slate-800 text-sm text-white placeholder-slate-500 border border-slate-700 rounded-lg pl-4 pr-10 py-3 focus:outline-none focus:border-orange-500 transition">
                    <button
                        class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 flex items-center justify-center text-slate-400 hover:text-orange-500 transition">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </main>

    <!-- Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // 0. Fetch Latest Data
            await WorkshopManager.fetchData();

            // 1. Get Workshop ID
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const workshop = WorkshopManager.getWorkshopById(id);

            // 2. Fallback if not found
            if (!workshop) {
                // Try to find ANY live one
                const live = WorkshopManager.getFeaturedWorkshop();
                if (live) {
                    window.location.href = `workshop.html?id=${live.id}`;
                    return;
                }
                alert('Workshop not found.');
                window.location.href = 'index.html';
                return;
            }

            // 3. Determine Mode
            const now = new Date();
            const start = new Date(workshop.startTime);
            const end = new Date(workshop.endTime);
            // Status Override: If explicitly archived or time passed
            // Check 'status' property first for manual override
            const isArchived = workshop.status === 'archived' || (now > end && workshop.status !== 'upcoming');
            const isLive = workshop.status === 'live' || (now >= start && now <= end);
            const isUpcoming = !isArchived && !isLive;

            // 4. Auth Check (Only for Live/Upcoming)
            if (!isArchived && !Auth.isLoggedIn()) {
                window.location.href = `index.html?redirect=workshop&id=${id}`;
                return;
            }

            // 5. Update UI
            document.title = `${workshop.title} | Workshop`;
            document.getElementById('workshop-title-nav').textContent = isArchived ? 'Recorded Session' : (isLive ? 'Live Workshop' : 'Upcoming Event');

            // Video Player Logic
            const player = document.getElementById('workshop-player');
            if (workshop.videoID) {
                let src = `https://www.youtube.com/embed/${workshop.videoID}?rel=0&modestbranding=1`;
                // Only autoplay if LIVE
                if (isLive) src += '&autoplay=1';
                player.src = src;
            } else {
                // No video ID? Show overlay
                document.getElementById('video-wrapper').style.background = '#000';
            }

            // LIVE Badge Indicator
            const indicator = document.getElementById('live-indicator').querySelector('span');
            if (isArchived) {
                indicator.className = 'w-2 h-2 rounded-full bg-slate-600'; // Gray dot
            } else if (isLive) {
                indicator.className = 'w-2 h-2 rounded-full bg-red-500 animate-pulse'; // Red dot
            } else {
                indicator.className = 'w-2 h-2 rounded-full bg-orange-500'; // Orange dot
            }

            // Handle States
            if (isArchived) {
                // ARCHIVED MODE: Hide Chat, Expand Player
                document.getElementById('workshop-sidebar').style.display = 'none';

                const main = document.getElementById('main-layout');
                main.classList.remove('lg:flex-row');
                main.classList.add('flex-col', 'items-center', 'justify-center', 'bg-black');

                const container = document.getElementById('player-container');
                container.style.width = '100%';
                container.style.maxWidth = '1200px';
                container.style.aspectRatio = '16/9';
                container.classList.remove('flex-1');
                container.classList.add('shadow-2xl');

                // Add "Recorded" Badge
                const badge = document.createElement('div');
                badge.className = 'absolute top-6 left-6 bg-black/80 text-white px-4 py-2 text-sm font-bold rounded backdrop-blur-md border border-white/10 z-20';
                badge.innerHTML = '<i class="fa-solid fa-clock-rotate-left mr-2 text-orange-500"></i> RECORDED';
                container.appendChild(badge);

            } else if (isUpcoming) {
                // UPCOMING MODE
                const overlay = document.getElementById('player-overlay');
                overlay.classList.remove('hidden');
                document.getElementById('overlay-msg').innerHTML = `
                    <div class="text-center p-6">
                        <div class="text-3xl font-bold text-white mb-4">Stream Starting Soon</div>
                        <div class="text-xl text-orange-500 font-mono bg-slate-800/50 px-4 py-2 rounded border border-slate-700">
                            ${start.toLocaleString()}
                        </div>
                        <p class="text-slate-400 mt-4 text-sm max-w-md mx-auto">${workshop.desc}</p>
                    </div>
                `;
            } else if (isLive && !workshop.videoID) {
                // LIVE but no video ID ?
                const overlay = document.getElementById('player-overlay');
                overlay.classList.remove('hidden');
                document.getElementById('overlay-msg').textContent = "Waiting for stream signal...";
            }
        });
    </script>

</body>

</html>